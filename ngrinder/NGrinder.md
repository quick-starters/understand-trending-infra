## NGrinder

![](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FbhFzuS%2FbtqW4iklhOC%2FKdvOzva7ZFkdPEn8yzuY91%2Fimg.png)

- Jython(jvm 위에 python 올림) or Groovy 스크립트를 이용한 JVM 환경 위에서 스트레스 테스트를 할 수 있는 도구.
- web ui 기반의 인터페이스를 제공해주어 쉽게 사용 가능.
- Controller와  agent로 구성되어 Controller ( agentmanager)가 agent를 제어하여 부하를 발생시키는 구조.



### controller docker

```
docker run -d -v ~/ngrinder-controller:/opt/ngrinder-controller --name controller -p 80:80 -p 16001:16001 -p 12000-12009:12000-12009 ngrinder/controller:3.4
```

> 80: contoller port
>
> 16001 : 테스트를 하지 않은 에이전트가 컨트롤러에게 “할 일 없으니 테스트 가능” 이라는 메세지를 알려주는 포트
> 컨트롤러는 “테스트가 실행하는데 해당 테스트는 1200x에서 발생하니, 해당 포트에 접속해서 테스트 실행 준비” 라는 메세지를 에이전트에게 지시를 한다.
> 12000 ~ 1200x 포트는 “테스트 실행, 테스트 종료” 와 같은 컨트롤러 명령어와 에이전트별 테스트 실행 통계를 초별로 수집하는 포트.

### agent docker run

```
docker run -v ~/ngrinder-agent:/opt/ngrinder-agent -d ngrinder/agent:3.4 127.0.0.1:80

docker run -v ~/ngrinder-agent:/opt/ngrinder-agent --link controller:controller -d ngrinder/agent:3.4 // 같은 호스트내에서 연결하려면 link 옵션을 통해 컨테이너끼리 연결해준다.
```

- agent에서 host로 때릴 때 예약어를 사용하여 host를 지정한다.`host.docker.internal`





#### Ramp-up

- ramp-up 설정을 통해 worker의 동작모드를 process, thread 등으로 설정 가능
- 초기 thread 개수 등등에 대한 설정 가능.

 

#### Custom script

- groovy or python으로 부하테스트를 위한 Httprequest script를 작성할 수 있음
- 여기서 커스텀 헤더, 커스텀 body 등 데이터를 넣어서 요청할 수 있다.



```
import static net.grinder.script.Grinder.grinder
import static org.junit.Assert.*
import static org.hamcrest.Matchers.*
import net.grinder.plugin.http.HTTPRequest
import net.grinder.plugin.http.HTTPPluginControl
import net.grinder.script.GTest
import net.grinder.script.Grinder
import net.grinder.scriptengine.groovy.junit.GrinderRunner
import net.grinder.scriptengine.groovy.junit.annotation.BeforeProcess
import net.grinder.scriptengine.groovy.junit.annotation.BeforeThread
// import static net.grinder.util.GrinderUtils.* // You can use this if you're using nGrinder after 3.2.3
import org.junit.Before
import org.junit.BeforeClass
import org.junit.Test
import org.junit.runner.RunWith

import java.util.Date
import java.util.List
import java.util.ArrayList

import HTTPClient.Cookie
import HTTPClient.CookieModule
import HTTPClient.HTTPResponse
import HTTPClient.NVPair

/**
 * A simple example using the HTTP plugin that shows the retrieval of a
 * single page via HTTP. 
 * 
 * This script is automatically generated by ngrinder.
 * 
 * @author admin
 */
@RunWith(GrinderRunner)
class TestRunner {

	public static GTest test
	public static HTTPRequest request
	public static NVPair[] headers = []
	public static NVPair[] params = []
	public static Cookie[] cookies = []

	@BeforeProcess
	public static void beforeProcess() {
		HTTPPluginControl.getConnectionDefaults().timeout = 6000 // httpPlugin을 통해 timeout 설정.
		test = new GTest(1, "host.docker.internal") // * @param number      the test number
	 * @param description test description
		request = new HTTPRequest()
		grinder.logger.info("before process.");
	}

	@BeforeThread 
	public void beforeThread() {
		test.record(this, "test") // 테스트 리포트 결과를 recording할 테스트 메서드를 적어준다. 요거 안하면 테스트는 수행되지만 리포팅 안댐.
		grinder.statistics.delayReports=true; // 
		grinder.logger.info("before thread.");
	}
	
	@Before
	public void before() {
		request.setHeaders(headers) // header setting.
		cookies.each { CookieModule.addCookie(it, HTTPPluginControl.getThreadHTTPClientContext()) } // cookie setting.
		grinder.logger.info("before thread. init headers and cookies");
	}

	@Test
	public void test(){
		HTTPResponse result = request.GET("http://host.docker.internal:8080/hello", params)

		if (result.statusCode == 301 || result.statusCode == 302) {
			grinder.logger.warn("Warning. The response may not be correct. The response code was {}.", result.statusCode); // logging을 하면 테스트 보고서에서 로그를 다운받을 때 찍힌다.
		} else {
			assertThat(result.statusCode, is(200));
		}
	}
}

```









