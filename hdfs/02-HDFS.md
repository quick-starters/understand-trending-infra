# HDFS

HDFS(Hadoop Distributed File System)는 범용 하드웨어에서 동작하고, 장애 복구성을 가지는 분산 파일 시스템이다.

HDFS는 실시간 처리보다는 배치처리를 위해 설계됐다. 따라서 빠른 데이터 응답시간이 필요한 작업에는 적합하지 않다. 또한 네임노드가 단일 실패지점(SPOF)이 되기 때문에 네임노드 관리가 중요하다.

## 특징

### 블록 단위 저장

HDFS는 데이터를 블록 단위로 나누어 저장한다. 블록사이즈보다 작은 파일은 기존 파일의 사이즈로 저장하고, 블록 사이즈보다 큰 크기의 데이터파일은 블록단위를 나누어 저장하기 때문에 단일 디스크의
데이터보다 큰 파일도 저장할 수 있다.

블록단위가 256MB일 때 1G 파일은 4개의 블록으로 나누어 저장되고, 10MB 파일은 하나의 블록으로 저장된다.

### 블록 복제를 이용한 장애 복구

HDFS는 장애 복구를 위해서 각 블록을 복제하여 저장한다. 블록의 기본 복제 단위는 3이다. 하나의 블록은 3개의 블록으로 복제되고, 같은 랙(Rack)의 서버와 다른 랙(Rack)의 서버로 복제되어
저장된다. 블록에 문제가 생기면 복제한 다른 블록을 이용해서 데이터를 복구한다.

1G 데이터를 저장할 때 데이터 복제까지 총 3G의 저장공간이 필요하다.

### 읽기 중심

HDFS는 데이터를 한 번 쓰면 여러 번 읽는 것을 목적으로 한다. 따라서 파일의 수정은 지원하지 않는다. 파일의 수정을 제한하여 동작을 단순화하고 이를 통해 데이터를 읽을 때 속도를 높일 수 있다.

### 데이터 지역성

MapReduce는 HDFS의 데이터 지역성을 이용해서 처리 속도를 증가시킨다. 처리 알고리즘이 있는 곳에 데이터를 이동시키지 않고, 데이터가 있는 곳에서 알고리즘을 처리하여 네트워크를 통해 대용량
데이터를 이동시키는 비용을 줄일 수 있다.

## 구조

![HDFS Architecture](./images/image-4.png)

### 네임노드

네임노드의 주요 역할은 메타데이터 관리와 데이터노드의 관리이다.

#### 메타데이터 관리

메타데이터는 파일이름, 파일크기, 파일생성시간, 파일접근권한, 파일 소유자 및 그룹 소유자, 파일이 위치한 블록의 정보 등으로 구성된다. 각 데이터노드에서 전달하는 메타데이터를 받아서 전체노드의
메타데이터 정보와 파일 정보를 묶어서 관리한다.

#### 데이터노드 관리

네임노드는 데이터노드가 주기적으로 전달하는 하트비트(default 3초)와 블록리포트(default 6시간)를 이용하여 데이터 노드의 동작상태, 블록상태를 관리한다.

### 데이터노드

데이터노드는 파일을 저장하는 역할을 한다. 파일은 블록단위로 저장된다. 데이터노드는 주기적으로 네임노드에 하트비트와 블록리포트를 전달한다.

#### 블록 파일 저장형태

사용자가 설정한 위치에 다음과 같은 파일의 형태로 저장된다.

```shell
./hdfs/current/BP-11233441/current/finalized/subdir187/subdir191:
total 676K
drwxr-xr-x   2 hdfs hdfs 4.0K Sep  8 04:30 .
drwxr-xr-x 258 hdfs hdfs 8.0K Aug 31 22:21 ..
-rw-r--r--   1 hdfs hdfs  40K Aug 31 22:46 blk_12345
-rw-r--r--   1 hdfs hdfs  327 Aug 31 22:46 blk_12345_29082353.meta
-rw-r--r--   1 hdfs hdfs  19K Aug 31 22:46 blk_12346
-rw-r--r--   1 hdfs hdfs  155 Aug 31 22:46 blk_12346_29082375.meta
-rw-r--r--   1 hdfs hdfs 262K Aug 31 22:46 blk_12347
-rw-r--r--   1 hdfs hdfs 2.1K Aug 31 22:46 blk_12347_29082433.meta
```

#### 파일 읽기/쓰기

HDFS의 파일에 접근하는 가장 간단한 방법은 HDFS 명령행 인터페이스를 이용하는 것이다. 또한 Java, C API를 제공하여 이를 구현해서 접근하면 된다.

- 파일 읽기
    1. 네임노드에 파일이 보관된 블록 위치 요청
    2. 네임노드가 블록 위치 반환
    3. 각 데이터 노드에 파일 블록을 요청
        - 노드의 블록이 깨져 있으면 네임노드에 이를 통지하고 다른 블록 확인
- 파일 쓰기
    1. 네임노드에 파일 정보를 전송하고, 파일의 블록을 써야할 노드 목록 요청
    2. 네임노드가 파일을 저장할 목록 반환
    3. 데이터 노드에 파일 쓰기 요청
        - 데이터 노드간 복제가 진행
