

![Apache kafka 개요](./images/6a46514d46e0edd07ab4e80c828d60a8.png)

# apache Kafka 

## 브로커에 대하여

### broker

![image-20211007200447134](./images/image-20211007200447134.png)

*카프카가 설치되어 있는 서버*

카프카 브로커는 카프카가 설치되어 있는 서버 단위를 말한다. 



![image-20211007200528670](./images/image-20211007200528670.png)

보통 3개 이상의 서버로 구성하기를 권장한다.



### replication

카프카 아키텍쳐의 핵심이다. 클러스터에서 서버에 장애가 생겼을 때 가용성을 보장하는 가장 좋은 방법이 복제이기 때문이다. 



![image-20211007200630976](./images/image-20211007200630976.png)

*카프카 레플리케이션*

레플리케이션은 파티션의 복제를 뜻한다. 파티션이 1이고 레플리케이션이 3이면 위와 같이 원본 1개와 복제본 2개로 총 3개의 파티션이 존재하게된다.

브로커 개수에 따라 레플리케이션 개수가 제한 된다. 즉 브로커 개수가 3이니 3을 초과하는 레플리케이션은 불가능하다.



![image-20211007200814490](./images/image-20211007200814490.png)

*리더 파티션과 팔로워 파티션*

원본 파티션을 리더 파티션, 복제된 파티션을 팔로워 파티션이라고 부른다.



![image-20211007200843829](./images/image-20211007200843829.png)

*ISR(In Sync Replica)*

리더 파티션과 팔로워 파티션을 합쳐서 ISR이라고 볼 수 있다.



#### replication의 사용 이유

레플리케이션은 파티션의 고가용성을 위해 사용된다. 

> ✏️ 고가용성(High Availability)이란
>
> 가용성이란 말 그대로 가용(사용 가능)한 시간을 말한다. 고가용성이란 서버와 네트워크 또는 프로그램 등의 정보 시스템이 상당히 오랜 기간 동안 지속적으로 장애 없이 운영이 가능한 성질을 말함. 



![image-20211007201122296](./images/image-20211007201122296.png)

*브로커의 장애 상황*

리더 파티션이 장애가 나도 나머지 팔로워 파티션이 리더 파티션 역할을 승계한다.



#### leader partition과 follower partition의 차이

![image-20211007201212816](./images/image-20211007201212816.png)

*리더 파티션과 팔로워 파티션 그리고 프로듀서*

프로듀서가 토픽의 파티션에 데이터를 전달한다. 이 때 데이터를 전달 받는 주체가 리더 파티션이다



#### 프로듀서의 ack 옵션

프로듀서에서는 브로커에 대해 `ack`라는 상세 옵션이 있는데 이를 통해 고가용성을 유지할 수 있게 된다. 이 옵션은 파티션의 레플리케이션과 연관이 있다. 이에 대한 설명은 [링크](https://www.popit.kr/kafka-%ec%9a%b4%ec%98%81%ec%9e%90%ea%b0%80-%eb%a7%90%ed%95%98%eb%8a%94-producer-acks/) 참고



![image-20211007201418405](./images/image-20211007201418405.png)

*ack=0 옵션일 경우*

리더 파티션에 데이터를 전송하고 응답값을 받지 않는다. 데이터가 정상적으로 전송되었는지, 나머지 팔로워 파티션에 복제가 정상적으로 되었는지 알 수 없다. 

그러므로 속도는 빠르지만, 데이터 유실 가능성이 있다.



![image-20211007201428391](./images/image-20211007201428391.png)

*ack=1 옵션일 경우*

리더 파티션이 데이터를 받았는지 응답값을 받지만, 나머지 파티션에 복제되었는지 알 수 없다. 만약 리더 파티션이 데이터를 받는 즉시 장애가 난다면 나머지 파티션에 복제가 되지 않을 수 있다.



![image-20211007201438927](./images/image-20211007201438927.png)

*ack=all 옵션일 경우*

복제가 이루어졌는지까지 응답을 받아 확인한다.

데이터 유실은 없지만 0, 1에 비해 확인하는 것이 많아 속도가 현저히 느리다고 한다.



> ⚠️ 그럼 replication이 많을수록 좋은거 아니야?
>
> 너무 많은 파티션의 수는 단점으로 작용할 수도 있듯이 너무 많은 리플리케이션의 수 역시 문제점을 야기할 수 있다.
>
> 1. 저장공간
>
> 첫 번째로 저장 공간의 문제점이 생긴다. 예를 들어 파티션의 사이즈가 100GB인 브로커가 있다. 그리고 만약 이 브로커의 리플리케이션 팩터는 3이라면 (자신을 포함) 카프카 클러스터 내 필요한 총저장소의 크기는 300GB가 된다.
>
> 2. 브로커 리소스 사용량 증가
>
> 두 번째로 브로커의 리소스 사용량 증가이다. 브로커에서는 완벽한 리플리케이션을 위해서 사용자가 알아차리지 못하는 사이 비활성화된 토픽이 리플리케이션이 잘되고 있는지 계속해서 상태를 체크하는 작업이 이루어진다. 따라서 리플리케이션 역시 적당한 수를 채택하는 것이 필요하다.



## 참고

- [데브원영 유튜브](https://youtu.be/qpEEoGpWVig)
- [ooeunz 블로그](https://ooeunz.tistory.com/115)

